<div
  class="p-4 md:p-8 bg-gray-50 dark:bg-gray-900 min-h-screen"
>
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
  >
    <div class="flex items-center gap-3">
      <button
        (click)="promptToJoinGroup()"
        [disabled]="isJoiningGroup()"
        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow transition duration-200 flex items-center gap-2 disabled:bg-gray-400 dark:disabled:bg-gray-600"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="w-5 h-5"
        >
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
          <line x1="19" x2="19" y1="8" y2="14" />
          <line x1="16" x2="22" y1="11" y2="11" />
        </svg>

        @if (isJoiningGroup()) { Entrando... } @else { Entrar em Grupo }
      </button>

      <button
        (click)="openAddExpenseModal()"
        class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-5 rounded-lg shadow transition duration-200 flex items-center gap-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="w-5 h-5"
        >
          <path d="M5 12h14" />
          <path d="M12 5v14" />
        </svg>
        Adicionar Gasto
      </button>
    </div>
  </div>

  @if (loading()) {
  <div class="animate-pulse">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="h-28 bg-gray-200 dark:bg-gray-800 rounded-lg"></div>
      <div class="h-28 bg-gray-200 dark:bg-gray-800 rounded-lg"></div>
      <div class="h-28 bg-gray-200 dark:bg-gray-800 rounded-lg"></div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
      <div class="lg:col-span-2 bg-gray-200 dark:bg-gray-800 rounded-lg h-64"></div>
      <div class="lg:col-span-1 bg-gray-200 dark:bg-gray-800 rounded-lg h-64"></div>
    </div>
  </div>

  } @else {
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div
      class="bg-green-100 dark:bg-gray-800 border border-green-200 dark:border-green-700 p-6 rounded-lg shadow-md flex items-center gap-4"
    >
      <div
        class="flex-shrink-0 bg-green-200 dark:bg-green-900 p-3 rounded-full"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="w-6 h-6 text-green-700 dark:text-green-400"
        >
          <path d="M7 7h10v10" />
          <path d="M7 17 17 7" />
        </svg>
      </div>
      <div>
        <p class="text-sm font-medium text-green-700 dark:text-green-400">
          Me Devem
        </p>
        <p class="text-3xl font-bold text-green-900 dark:text-green-200 mt-1">
          {{ owedToUser() | currency:'BRL' }}
        </p>
      </div>
    </div>

    <div
      class="bg-red-100 dark:bg-gray-800 border border-red-200 dark:border-red-700 p-6 rounded-lg shadow-md flex items-center gap-4"
    >
      <div class="flex-shrink-0 bg-red-200 dark:bg-red-900 p-3 rounded-full">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="w-6 h-6 text-red-700 dark:text-red-400"
        >
          <path d="M17 7 7 17" />
          <path d="M17 17H7V7" />
        </svg>
      </div>
      <div>
        <p class="text-sm font-medium text-red-700 dark:text-red-400">
          Você Deve
        </p>
        <p class="text-3xl font-bold text-red-900 dark:text-red-200 mt-1">
          {{ userOwes() | currency:'BRL' }}
        </p>
      </div>
    </div>

    <div
      class="bg-blue-100 dark:bg-gray-800 border border-blue-200 dark:border-blue-700 p-6 rounded-lg shadow-md flex items-center gap-4"
    >
      <div class="flex-shrink-0 bg-blue-200 dark:bg-blue-900 p-3 rounded-full">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="w-6 h-6 text-blue-700 dark:text-blue-400"
        >
          <path d="m16 16 3-8 3 8c-.8.9-2 1-3 1-1 0-2.1-.1-3-1Z" />
          <path d="m2 16 3-8 3 8c-.8.9-2 1-3 1-1 0-2.1-.1-3-1Z" />
          <path d="M7 21h10" />
          <path d="M12 3v18" />
          <path d="M3 7h2" />
          <path d="M19 7h2" />
        </svg>
      </div>
      <div>
        <p class="text-sm font-medium text-blue-700 dark:text-blue-400">
          Saldo Final
        </p>
        <p class="text-3xl font-bold text-blue-900 dark:text-blue-200 mt-1">
          {{ netBalance() | currency:'BRL' }}
        </p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col justify-center items-center">

      <div class="flex items-center gap-3 mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-gray-700 dark:text-gray-300"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
          <h3 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
              Resumo
          </h3>
      </div>

      <app-category-pie-chart [breakdown]="categoryBreakdown()"></app-category-pie-chart>
    </div>
    <div
      class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg"
    >
      <div class="flex items-center gap-3 mb-4">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="w-6 h-6 text-gray-700 dark:text-gray-300"
        >
          <line x1="8" x2="21" y1="6" y2="6" />
          <line x1="8" x2="21" y1="12" y2="12" />
          <line x1="8" x2="21" y1="18" y2="18" />
          <line x1="3" x2="3.01" y1="6" y2="6" />
          <line x1="3" x2="3.01" y1="12" y2="12" />
          <line x1="3" x2="3.01" y1="18" y2="18" />
        </svg>
        <h3 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
          Atividade Recente
        </h3>
      </div>

      <ul class="divide-y divide-gray-200 dark:divide-gray-700">
        @for (expense of recentExpenses(); track expense?.id) {
        <li class="py-4 flex justify-between items-center">
          <div class="flex items-center space-x-4">
            <div
              class="flex-shrink-0 bg-gray-100 dark:bg-gray-700 p-2 rounded-full"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-5 h-5 text-gray-500 dark:text-gray-400"
              >
                <path
                  d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"
                />
                <path d="M16 8h-6a2 2 0 1 0 0 4h6" />
                <path d="M12 17.5v-11" />
              </svg>
            </div>
            <div>
              <p class="text-gray-500 dark:text-gray-400">{{ expense?.date?.toLocaleDateString() }}</p>
              <p class="font-semibold text-gray-800 dark:text-gray-100">
                {{ expense?.description }}
              </p>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                Em
                <span class="font-medium text-blue-600 dark:text-blue-400">{{
                  expense?.groupName
                }}</span>
                <span> • Pago por {{ expense?.payerName }}</span>
              </p>
            </div>
          </div>
          <p class="font-bold text-lg text-gray-800 dark:text-gray-100">
            {{ expense?.value | currency:'BRL' }}
          </p>
        </li>
        } @empty {
        <p class="text-center text-gray-500 dark:text-gray-400 py-6">
          Nenhuma atividade registrada ainda.
        </p>
        }
      </ul>
    </div>

    <div
      class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg"
    >
      <div class="flex items-center gap-3 mb-4">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="w-6 h-6 text-gray-700 dark:text-gray-300"
        >
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
          <path d="M16 3.13a4 4 0 0 1 0 7.75" />
        </svg>
        <h3 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
          Grupos Ativos
        </h3>
      </div>

      <ul class="space-y-3">
        @for (group of activeGroups(); track group.id) {
        <li
          (click)="navigateToGroup(group.id)"
          class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-blue-400 dark:hover:border-blue-500 transition-all duration-200 flex items-center justify-between space-x-3"
        >
          <div>
            <p class="font-semibold text-gray-800 dark:text-gray-100">
              {{ group.name }}
            </p>
            <p class="text-sm text-gray-500 dark:text-gray-400">
              {{ group.memberIds.length }} membros
            </p>
          </div>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-5 h-5 text-gray-400 dark:text-gray-500"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m8.25 4.5 7.5 7.5-7.5 7.5"
            />
          </svg>
        </li>
        } @empty {
        <p class="text-center text-gray-500 dark:text-gray-400 py-6">
          Você ainda não participa de grupos.
        </p>
        }
      </ul>

      @if (activeGroups()?.length) {
      <button
        (click)="navigateToGroupsList()"
        class="w-full mt-4 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-lg transition duration-200"
      >
        Ver Todos os Grupos
      </button>
      }
    </div>
  </div>
  }
</div>

@if (addingExpense()) { 
  <div
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
   <form [formGroup]="addExpenseForm" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-96"
     (ngSubmit)="onSubmitAddExpense()"
    >
      <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">
        Adicionar Nova Despesa
      </h2>
      <div class="mb-4">
        <label
          class="block text-gray-700 dark:text-gray-300 font-medium mb-2"
          for="description"
          >Grupo</label
        >
        <select
          id="group"
          formControlName="groupId"
          name="groupId"
          required
          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
        >
          <option value="" disabled selected>Selecione um grupo</option>
          @for (group of activeGroups(); track group.id) {
          <option value="{{ group.id }}">{{ group.name }}</option>
          }
        </select>
        <label
          class="block text-gray-700 dark:text-gray-300 font-medium mb-2"
          for="description"
          >Descrição</label
        >
        <input
          type="text"
          id="description"
          formControlName="description"
          name="description"
          required
          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
        />
      </div>
      <div class="mb-4">
        <label
          class="block text-gray-700 dark:text-gray-300 font-medium mb-2"
          for="value"
          >Valor (R$)</label
        >
        <input
          type="number"
          id="value"
          formControlName="value"
          name="value"
          required
          min="0.01"
          step="0.01"
          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
        />
        <label
          class="block text-gray-700 dark:text-gray-300 font-medium mb-2"
          for="category"
          >Categoria</label
        >
        <input
          type="text"
          id="category"
          formControlName="category"
          name="category"
          required
          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
        />
      </div>
      <div class="flex justify-end gap-3">
        <button
          type="button"
          (click)="closeAddExpenseModal()"
          class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-lg transition duration-200"
        >
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="addExpenseLoading()"
          class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center gap-2 disabled:bg-gray-400 dark:disabled:bg-gray-600"
        >
          @if (addExpenseLoading()) { Adicionando...  } @else { Adicionar Despesa  }
        </button>
      </div>
    </form>
  </div>
}